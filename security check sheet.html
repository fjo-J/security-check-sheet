<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>セキュリティチェックシート AIナレッジベース & ロードマップ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-btn.active { border-color: #3b82f6; background-color: #3b82f6; color: white; }
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; min-width: 1200px; }
        th, td { padding: 10px; border: 1px solid #e5e7eb; vertical-align: top; white-space: normal; word-wrap: break-word; }
        th { background-color: #f3f4f6; font-weight: 700; position: sticky; top: 0; z-index: 1; cursor: pointer; }
        th .sort-indicator { display: inline-block; margin-left: 5px; color: #9ca3af; }
        .search-box { position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 1rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #update-table input, #update-table select, #roadmap-review-table input, #roadmap-review-table select { width: 100%; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; }
        #update-table textarea, #roadmap-review-table textarea { width: 100%; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; height: 100px; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">

    <div id="app" class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg">
        <header class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">セキュリティチェックシート ナレッジ＆ロードマップ</h1>
        </header>

        <div class="px-4 pt-4 border-b border-gray-200">
            <nav class="flex flex-wrap space-x-2" id="tabs">
                <button data-tab="search" class="tab-btn active px-4 py-2 text-sm font-medium border-b-2 border-transparent rounded-t-md">① 検索＆回答</button>
                <button data-tab="knowledge" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent rounded-t-md">② ナレッジベース</button>
                <button data-tab="roadmap" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent rounded-t-md">③ ロードマップ</button>
                <button data-tab="master" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent rounded-t-md">④ カテゴリマスタ</button>
                <button data-tab="manual" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent rounded-t-md">⑤ 使い方</button>
                <button data-tab="updater" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent rounded-t-md">⑥ AI一括更新</button>
            </nav>
        </div>

        <main class="p-4 sm:p-6">
            <div id="search-content" class="tab-content"></div>
            <div id="knowledge-content" class="tab-content hidden"></div>
            <div id="roadmap-content" class="tab-content hidden"></div>
            <div id="master-content" class="tab-content hidden"></div>
            <div id="updater-content" class="tab-content hidden"></div>
            <div id="manual-content" class="tab-content hidden"></div>
        </main>
    </div>

<script type="module">
    // --- Data Section ---
    let knowledgeBaseData = [
        { "id": "SEC-0001", "daiCategory": "組織的セキュリティ", "chuCategory": "情報セキュリティ認証", "question": "ISMS (ISO/IEC 27001) など、第三者による情報セキュリティ認証を取得していますか？", "keywords": "ISMS,ISO27001,認証,Pマーク,プライバシーマーク", "answer": "はい。当社は情報セキュリティマネジメントシステム（ISMS）の国際規格である「ISO/IEC 27001」の認証を取得しております。", "supplement": "認証範囲や取得日などの詳細情報が必要な場合は、別途お問い合わせください。", "department": "情報システム部", "updated": "2025/08/27" },
        { "id": "SEC-0002", "daiCategory": "組織的セキュリティ", "chuCategory": "インシデント管理", "question": "情報漏洩やサービス停止など、セキュリティインシデント発生時の対処方法は確立されていますか？", "keywords": "インシデント,障害,漏洩,サービス停止,BCP", "answer": "はい。情報セキュリティインシデント対応規程を定め、インシデントの検知、報告、分析、復旧、再発防止策までの一連のプロセスを定義しています。重大なインシデント発生時には、経営層を含むインシデントレスポンスチームを招集し、迅速に対応します。", "supplement": "インシデント対応フロー図を別途ご提示可能です。", "department": "情報システム部", "updated": "2025/08/27" },
    ];
    let roadmapData = [
        { "id": "RM-0001", "question": "多要素認証は導入されていますか？", "current_state": "現在はID/パスワード認証のみ", "status": "未対応", "priority": "高", "department": "開発部", "target_date": "2025-12-31", "completion_date": "", "certification": "", "notes": "次期バージョンで実装を検討" },
        { "id": "RM-0002", "question": "SOC2 Type2レポートは取得していますか？", "current_state": "未取得", "status": "未対応", "priority": "中", "department": "情報システム部", "target_date": "2026-03-31", "completion_date": "", "certification": "SOC2 Type2", "notes": "監査法人と協議開始予定" }
    ];

    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
    
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        setupTabs();
        populateSearchTab();
    }

    function setupTabs() {
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                const targetId = tab.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${targetId}-content`).classList.remove('hidden');

                const populateFunctions = {
                    search: populateSearchTab,
                    knowledge: populateKnowledgeBase,
                    roadmap: populateRoadmapTab,
                    master: populateCategoryMaster,
                    updater: populateUpdaterTab,
                    manual: populateManual
                };
                populateFunctions[targetId]();
            });
        });
    }

    function populateSearchTab() {
        const container = document.getElementById('search-content');
        if (container.innerHTML) return;
        container.innerHTML = `
            <div class="search-box">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">↓ここにクライアントからの質問を貼り付けて検索</label>
                <input type="text" id="search-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="例：ISMS 認証">
            </div>
            <h2 class="text-xl font-semibold text-gray-800 mt-6 mb-4">検索結果</h2>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th>ID</th><th>カテゴリ</th><th>質問</th><th>標準回答</th><th>補足情報</th></tr></thead>
                    <tbody id="search-results"></tbody>
                </table>
            </div>`;
        document.getElementById('search-input').addEventListener('input', performSearch);
        performSearch();
    }

    function populateKnowledgeBase() {
        const container = document.getElementById('knowledge-content');
        container.innerHTML = `
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ナレッジベース一覧</h2>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th>ID</th><th>大カテゴリ</th><th>中カテゴリ</th><th>質問</th><th>キーワード</th><th>標準回答</th><th>補足情報</th><th>担当部署</th><th>最終更新日</th></tr></thead>
                    <tbody>${knowledgeBaseData.map(item => `
                        <tr class="hover:bg-gray-50">
                            <td>${item.id||''}</td><td>${item.daiCategory||''}</td><td>${item.chuCategory||''}</td><td>${item.question||''}</td><td>${item.keywords||''}</td><td>${item.answer||''}</td><td>${item.supplement||''}</td><td>${item.department||''}</td><td>${item.updated||''}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    function populateRoadmapTab() {
        const container = document.getElementById('roadmap-content');
        container.innerHTML = `
            <h2 class="text-xl font-semibold text-gray-800 mb-4">未対応項目ロードマップ</h2>
            <p class="text-sm text-gray-600 mb-4">現在未対応となっている項目の一覧です。</p>
            <div class="table-container">
                <table id="roadmap-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th>ID</th><th>項目名</th><th>現状</th><th>ステータス</th><th>優先度</th><th>担当部署</th><th>対応完了予定日</th><th>対応完了日</th><th>必要な外部認証</th><th>備考</th>
                        </tr>
                    </thead>
                    <tbody id="roadmap-table-body">${roadmapData.map(item => `
                        <tr class="hover:bg-gray-50">
                            <td>${item.id}</td><td>${item.question}</td><td>${item.current_state}</td><td>${item.status}</td>
                            <td>${item.priority}</td><td>${item.department}</td><td>${item.target_date}</td><td>${item.completion_date}</td>
                            <td>${item.certification}</td><td>${item.notes}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    function populateCategoryMaster() {
        const container = document.getElementById('master-content');
        const daiCategories = [...new Set(knowledgeBaseData.map(item => item.daiCategory).filter(Boolean))];
        const chuCategories = [...new Set(knowledgeBaseData.map(item => item.chuCategory).filter(Boolean))];
        container.innerHTML = `
            <h2 class="text-xl font-semibold text-gray-800 mb-4">カテゴリマスタ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><h3 class="font-semibold text-lg mb-2 border-b pb-2">大カテゴリ</h3><ul class="list-disc list-inside">${daiCategories.map(c => `<li>${c}</li>`).join('')}</ul></div>
                <div><h3 class="font-semibold text-lg mb-2 border-b pb-2">中カテゴリ</h3><ul class="list-disc list-inside">${chuCategories.map(c => `<li>${c}</li>`).join('')}</ul></div>
            </div>`;
    }

    function populateManual() {
        const container = document.getElementById('manual-content');
        if (container.innerHTML) return;
        container.innerHTML = `
            <h2 class="text-xl font-semibold text-gray-800 mb-4">使い方・運用フロー</h2>
            <div class="space-y-6 text-gray-700 prose max-w-none">
                <p>このツールは、セキュリティチェックシートへの回答業務と、未対応項目の管理を効率化するためのツールです。</p>
                <h3>ナレッジの検索と利用</h3>
                <ol>
                    <li><strong>「① 検索＆回答」タブ</strong> を開きます。</li>
                    <li>上部の検索ボックスに、顧客からの質問や関連キーワードを入力します。</li>
                </ol>
                <h3>ナレッジとロードマップの一括更新</h3>
                 <ol>
                    <li><strong>【初回のみ】</strong>「⑥ AI一括更新」タブで、必要なAPIキーを設定します。</li>
                    <li><strong>「⑥ AI一括更新」タブ</strong> を開きます。</li>
                    <li>チェックシートファイルを1つアップロードします。<strong>(対応形式: .csv, .txt, .pdf, 画像ファイル)</strong></li>
                    <li>AIがファイルから「対応済み項目（ナレッジ）」と「未対応項目（ロードマップ）」を自動で分類・抽出します。</li>
                    <li>抽出された内容を2つの表で確認し、必要に応じて修正・追記します。</li>
                    <li><strong>「GitHubに一括保存」</strong>ボタンをクリックすると、ナレッジベースとロードマップの両方が一度に更新されます。</li>
                </ol>
            </div>`;
    }

    function populateUpdaterTab() {
        const container = document.getElementById('updater-content');
        if (container.innerHTML) return;
        container.innerHTML = `
            <div class="space-y-8">
                <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg">
                    <h3 class="text-lg font-semibold">初回設定：各種APIキーの設定</h3>
                    <p class="text-sm text-gray-700 mt-1">AI解析とGitHub自動更新機能を利用するには、初回のみ各種キーの設定が必要です。</p>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="google-api-key" class="block text-sm font-medium text-gray-700">Google AI APIキー</label>
                            <input type="password" id="google-api-key" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="AIzaSy...">
                        </div>
                        <div>
                            <label for="github-pat" class="block text-sm font-medium text-gray-700">GitHub Personal Access Token (PAT)</label>
                            <input type="password" id="github-pat" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="github_pat_...">
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold">1. チェックシートファイルをアップロード</h3>
                    <p class="text-sm text-gray-600">AIがファイルから「対応済み」「未対応」を自動で分類・抽出します。<br><strong>(対応形式: .csv, .txt, .pdf, .png, .jpg など)</strong></p>
                    <input type="file" id="file-uploader" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
                <div id="ai-parser-status" class="hidden"></div>
                
                <div id="review-area" class="hidden space-y-8">
                    <div>
                        <h3 class="text-lg font-semibold">2. ナレッジベース追加候補（対応済み項目）</h3>
                        <div class="table-container"><table class="min-w-full"><thead class="bg-gray-50"><tr><th>質問</th><th>回答</th><th>大カテゴリ</th><th>中カテゴリ</th><th>キーワード</th><th>削除</th></tr></thead><tbody id="update-table"></tbody></table></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold">3. ロードマップ追加候補（未対応項目）</h3>
                        <div class="table-container"><table class="min-w-full"><thead class="bg-gray-50"><tr><th>項目名</th><th>現状(AI抽出)</th><th>ステータス</th><th>優先度</th><th>担当部署</th><th>必要な外部認証</th><th>削除</th></tr></thead><tbody id="roadmap-review-table"></tbody></table></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold">4. GitHubに一括保存</h3>
                        <button id="save-to-github-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700">ナレッジとロードマップを両方更新</button>
                        <div id="github-save-status" class="mt-2 text-sm"></div>
                    </div>
                </div>
            </div>`;
        
        document.getElementById('file-uploader').addEventListener('change', handleFileUpload);
        document.getElementById('save-to-github-btn').addEventListener('click', saveAllToGitHub);
        
        document.getElementById('google-api-key').value = sessionStorage.getItem('google_api_key') || '';
        document.getElementById('google-api-key').addEventListener('input', (e) => sessionStorage.setItem('google_api_key', e.target.value));
        
        document.getElementById('github-pat').value = sessionStorage.getItem('github_pat') || '';
        document.getElementById('github-pat').addEventListener('input', (e) => sessionStorage.setItem('github_pat', e.target.value));
    }

    function performSearch() {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const container = document.getElementById('search-results');
        const results = query === '' ? knowledgeBaseData : knowledgeBaseData.filter(item => 
            `${item.question || ''} ${item.keywords || ''}`.toLowerCase().includes(query)
        );
        
        if (results.length === 0) {
            container.innerHTML = `<tr><td colspan="5" class="text-center py-10">該当する回答が見つかりません。</td></tr>`;
        } else {
            container.innerHTML = results.map(item => `
                <tr><td>${item.id||''}</td><td>${(item.daiCategory||'') + ' > ' + (item.chuCategory||'')}</td><td>${item.question||''}</td><td>${item.answer||''}</td><td>${item.supplement||''}</td></tr>
            `).join('');
        }
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const statusContainer = document.getElementById('ai-parser-status');
        const reviewArea = document.getElementById('review-area');
        
        const supportedTypes = ['text/csv', 'text/plain', 'application/pdf', 'image/jpeg', 'image/png'];
        if (!supportedTypes.includes(file.type)) {
            let userFriendlyTypeName = 'このファイル形式';
            if (file.name.endsWith('.xlsx')) userFriendlyTypeName = 'Excel (.xlsx)';
            if (file.name.endsWith('.docx')) userFriendlyTypeName = 'Word (.docx)';
            
            statusContainer.innerHTML = `<div class="p-4 bg-red-50 text-red-800 rounded-md">エラー: ${userFriendlyTypeName} は直接サポートされていません。お手数ですが、CSV, TXT, PDF, または画像形式に変換してからアップロードしてください。</div>`;
            statusContainer.classList.remove('hidden');
            reviewArea.classList.add('hidden');
            return;
        }

        statusContainer.innerHTML = `<div class="flex items-center space-x-2 p-4 bg-blue-50 rounded-md"><div class="loader"></div><p>AIがファイルを解析中です...</p></div>`;
        statusContainer.classList.remove('hidden');
        reviewArea.classList.add('hidden');

        try {
            const base64 = await fileToBase64(file);
            const systemPrompt = `あなたはセキュリティ専門家です。提供された文書からQ&Aを抽出し、「対応済み」と「未対応」に分類してください。
- 「対応済み」は、肯定的・事実を述べる回答（はい、実施済み、〇〇です、など）を持つ項目です。
- 「未対応」は、否定的・未実施の回答（いいえ、未対応、×、No、など）を持つ項目です。
以下のJSON形式で出力してください。説明文は不要です。
{
  "knowledgeItems": [{"question": "質問文", "answer": "肯定的な回答文"}],
  "roadmapItems": [{"question": "質問文", "answer": "否定的な回答文"}]
}`;
            
            const extractedText = await callGeminiForExtraction(base64, file.type, systemPrompt);
            const result = JSON.parse(extractedText);

            renderUpdateTable(result.knowledgeItems || []);
            renderRoadmapReviewTable(result.roadmapItems || []);
            
            statusContainer.innerHTML = `<div class="p-4 bg-green-50 text-green-800 rounded-md">AIによる解析・分類が完了しました。下の2つの表で内容を確認・編集してください。</div>`;
            reviewArea.classList.remove('hidden');

        } catch (error) {
            console.error('AI解析エラー:', error);
            statusContainer.innerHTML = `<div class="p-4 bg-red-50 text-red-800 rounded-md">エラーが発生しました: ${error.message}</div>`;
        }
    }

    async function callGeminiForExtraction(base64, mimeType, systemPrompt) {
        const apiKey = sessionStorage.getItem('google_api_key');
        if (!apiKey) throw new Error("Google AI APIキーが設定されていません。");
        
        const payload = {
            contents: [{ parts: [{ text: systemPrompt }, { inline_data: { mime_type: mimeType, data: base64 } }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });

        if (!response.ok) { const err = await response.json(); throw new Error(`API Error: ${err.error.message}`); }
        const result = await response.json();
        return result.candidates[0].content.parts[0].text;
    }

    function renderUpdateTable(qaPairs) {
        const tableBody = document.getElementById('update-table');
        const daiCategories = [...new Set(knowledgeBaseData.map(item => item.daiCategory).filter(Boolean))];
        const chuCategories = [...new Set(knowledgeBaseData.map(item => item.chuCategory).filter(Boolean))];

        tableBody.innerHTML = qaPairs.map((pair, index) => `
            <tr id="row-${index}">
                <td><textarea name="question">${pair.question || ''}</textarea></td>
                <td><textarea name="answer">${pair.answer || ''}</textarea></td>
                <td><input list="dai-cat-list" name="daiCategory" placeholder="大カテゴリ"><datalist id="dai-cat-list">${daiCategories.map(c => `<option value="${c}">`).join('')}</datalist></td>
                <td><input list="chu-cat-list" name="chuCategory" placeholder="中カテゴリ"><datalist id="chu-cat-list">${chuCategories.map(c => `<option value="${c}">`).join('')}</datalist></td>
                <td><input type="text" name="keywords" placeholder="カンマ区切り"></td>
                <td><button onclick="document.getElementById('row-${index}').remove()" class="text-red-500 hover:text-red-700">✖</button></td>
            </tr>
        `).join('');
    }

    function renderRoadmapReviewTable(qaPairs) {
        const tableBody = document.getElementById('roadmap-review-table');
        tableBody.innerHTML = qaPairs.map((pair, index) => `
            <tr id="review-row-${index}">
                <td><textarea name="question">${pair.question || ''}</textarea></td>
                <td><textarea name="current_state">${pair.answer || ''}</textarea></td>
                <td><select name="status"><option>未対応</option><option>対応中</option><option>対応済</option></select></td>
                <td><select name="priority"><option>低</option><option>中</option><option>高</option></select></td>
                <td><input type="text" name="department" placeholder="担当部署"></td>
                <td><input type="text" name="certification" placeholder="例: ISO27001"></td>
                <td><button onclick="document.getElementById('review-row-${index}').remove()" class="text-red-500 hover:text-red-700">✖</button></td>
            </tr>
        `).join('');
    }

    async function saveAllToGitHub() {
        const pat = sessionStorage.getItem('github_pat');
        const statusDiv = document.getElementById('github-save-status');
        if (!pat) {
            statusDiv.innerHTML = `<p class="text-red-600">エラー: GitHub Personal Access Tokenが設定されていません。</p>`;
            return;
        }

        statusDiv.innerHTML = `<p class="text-blue-600">GitHubに保存中...</p>`;
        
        try {
            const updatedKnowledgeData = generateUpdatedKnowledgeDataArray();
            const updatedRoadmapData = generateNewRoadmapItems();
            
            const repoInfo = getRepoInfo();
            const filePath = 'index.html';

            const fileResponse = await fetch(`https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/contents/${filePath}`, { headers: { 'Authorization': `token ${pat}` }});
            if (!fileResponse.ok) throw new Error('GitHubからファイルを取得できませんでした。');
            const fileData = await fileResponse.json();
            let currentContent = atob(fileData.content);

            const newKnowledgeDataString = `let knowledgeBaseData = ${JSON.stringify(updatedKnowledgeData, null, 4)};`;
            const newRoadmapDataString = `let roadmapData = ${JSON.stringify(updatedRoadmapData, null, 4)};`;
            
            currentContent = currentContent.replace(/let knowledgeBaseData = \[[\s\S]*?\];/, newKnowledgeDataString);
            currentContent = currentContent.replace(/let roadmapData = \[[\s\S]*?\];/, newRoadmapDataString);

            const commitResponse = await fetch(`https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/contents/${filePath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${pat}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Batch update knowledge and roadmap on ${new Date().toLocaleString()}`,
                    content: btoa(unescape(encodeURIComponent(currentContent))),
                    sha: fileData.sha
                })
            });

            if (!commitResponse.ok) throw new Error('GitHubへの保存に失敗しました。');

            statusDiv.innerHTML = `<p class="text-green-600">成功！データが更新されました。ページをリロードします。</p>`;
            alert('ナレッジベースとロードマップが更新されました！');
            location.reload();

        } catch (error) {
            console.error('GitHub save error:', error);
            statusDiv.innerHTML = `<p class="text-red-600">エラー: ${error.message}</p>`;
        }
    }

    function generateUpdatedKnowledgeDataArray() {
        const tableRows = document.querySelectorAll('#update-table tr');
        const newEntries = [];
        let maxId = knowledgeBaseData.reduce((max, item) => Math.max(max, parseInt((item.id || 'SEC-0000').split('-')[1])), 0);

        tableRows.forEach(row => {
            maxId++;
            newEntries.push({
                id: `SEC-${String(maxId).padStart(4, '0')}`,
                question: row.querySelector('[name="question"]').value,
                answer: row.querySelector('[name="answer"]').value,
                daiCategory: row.querySelector('[name="daiCategory"]').value,
                chuCategory: row.querySelector('[name="chuCategory"]').value,
                keywords: row.querySelector('[name="keywords"]').value,
                supplement: '', department: '未定', updated: new Date().toISOString().split('T')[0]
            });
        });
        return [...knowledgeBaseData, ...newEntries];
    }

    function generateNewRoadmapItems() {
        const tableRows = document.querySelectorAll('#roadmap-review-table tr');
        const newEntries = [];
        let maxId = roadmapData.reduce((max, item) => Math.max(max, parseInt((item.id || 'RM-0000').split('-')[1])), 0);

        tableRows.forEach(row => {
            maxId++;
            newEntries.push({
                id: `RM-${String(maxId).padStart(4, '0')}`,
                question: row.querySelector('[name="question"]').value,
                current_state: row.querySelector('[name="current_state"]').value,
                status: row.querySelector('[name="status"]').value,
                priority: row.querySelector('[name="priority"]').value,
                department: row.querySelector('[name="department"]').value,
                target_date: "", completion_date: "",
                certification: row.querySelector('[name="certification"]').value,
                notes: ""
            });
        });
        return [...roadmapData, ...newEntries];
    }
    
    function getRepoInfo() {
        const hostname = window.location.hostname;
        const pathname = window.location.pathname;
        if (hostname.endsWith('github.io')) {
            const owner = hostname.split('.')[0];
            const repo = pathname.split('/')[1];
            if (!owner || !repo) throw new Error("リポジトリ情報をURLから特定できませんでした。");
            return { owner, repo };
        }
        console.warn("ローカル環境のため、GitHubの保存機能は動作しません。");
        return { owner: "YOUR_USERNAME", repo: "YOUR_REPONAME" };
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }
</script>
</body>
</html>
